# Ralph Progress Log
Started: Sun Feb  2 12:00:00 AM CST 2026
---

## Codebase Patterns
- Level-up flow in CharacterSheetPage uses pendingLevelUp state to track multi-step modals
- Class features are defined in src/data/classes.ts with Subclass interface
- Spell type includes optional source field for tracking origin (e.g., 'Lineage', 'Subclass')
- Subclass data includes features array and spells?: SubclassSpellGrant[] field
- SubclassSpellGrant interface: { level: number; spells: string[] }
- Spells database in src/data/spells.ts uses Spell interface with name, level, school, etc.

---

## 2026-02-01 - US-001: Add subclass spell data to class definitions
- Added SubclassSpellGrant interface to src/data/classes.ts
- Added spells field to Subclass interface
- Added Cleric domain spells for Life, Light, Trickery, War (levels 3, 5, 7, 9)
- Added Warlock patron spells for Archfey, Celestial, Fiend, Great Old One (levels 3, 5, 7, 9)
- Added Paladin oath spells for Devotion, Glory, Ancients, Vengeance (levels 3, 5, 9, 13, 17)
- Files changed: src/data/classes.ts
- **Learnings for future iterations:**
  - Subclass spells follow PHB 2024 format with character level thresholds
  - Clerics, Warlocks get spells at levels 3, 5, 7, 9 (matches spell slot progression)
  - Paladins get oath spells at 3, 5, 9, 13, 17 (every other paladin level from 3)

---

## 2026-02-01 - US-002: Add Druid and Ranger subclass spells
- Added Druid circle spells for Circle of Moon, Circle of Sea (levels 3, 5, 7, 9)
- Added Ranger subclass spells for Fey Wanderer, Gloom Stalker (levels 3, 5, 9, 13, 17)
- Verified Hunter and Beast Master have no subclass spells per PHB 2024
- Files changed: src/data/classes.ts
- **Learnings for future iterations:**
  - Not all subclasses have spells - Hunter and Beast Master rangers don't
  - Druid circles follow same pattern as Cleric domains (3, 5, 7, 9)
  - Ranger conclaves follow same pattern as Paladin oaths (3, 5, 9, 13, 17)

---

## 2026-02-01 - US-003: Add missing subclass spells to spells database
- Audited all subclass-granted spells against SPELLS array
- Added 26 missing spells to src/data/spells.ts:
  - Level 1: Bane, Heroism, Shield of Faith
  - Level 2: Detect Thoughts, Phantasmal Force, Rope Trick
  - Level 3: Beacon of Hope, Blink, Clairvoyance, Daylight, Fear, Nondetection, Stinking Cloud, Water Breathing
  - Level 4: Fount of Moonlight (2024 PHB)
  - Level 5: Commune, Conjure Elemental, Geas, Insect Plague, Legend Lore, Mislead, Modify Memory, Scrying, Seeming, Summon Celestial, Yolande's Regal Presence (2024 PHB)
- Files changed: src/data/spells.ts
- **Learnings for future iterations:**
  - Many PHB 2024 spells were already in the database
  - New 2024 PHB spells include Fount of Moonlight and Yolande's Regal Presence
  - Spell entries need all fields: name, level, school, castingTime, range, components, duration, concentration, ritual, description, classes

---

## 2026-02-01 - US-004: Create SubclassPickerModal component
- Created new component at src/components/SubclassPickerModal.tsx
- Props: isOpen, characterClass, onConfirm, onCancel
- Features:
  - Radio button selection for single subclass choice
  - Shows subclass name and description preview
  - Expandable "View Details" section for each subclass
  - Shows features by level when expanded
  - Shows subclass spells (domain/patron/oath spells) when expanded
  - Amber badge indicating "Subclass Spells Available" for subclasses with spells
  - Confirm button disabled until selection made
- Files changed: src/components/SubclassPickerModal.tsx (new)
- **Learnings for future iterations:**
  - Modal pattern: fixed inset-0 with z-50 for overlay
  - Use getSubclassesByClass(className) to get subclass list
  - Use getClassByName(className)?.subclassName for class-specific terminology (e.g., "Divine Domain", "Primal Path")
  - line-clamp-2 for truncating long descriptions

---

## 2026-02-01 - US-005: Prompt for subclass selection during level-up to level 3
- Modified handleLevelUpHPConfirm to check if leveling to level 3 and needs subclass
- Added showSubclassPickerModal state and selectedSubclass to pendingLevelUp type
- Created handleSubclassConfirm and handleSubclassCancel handlers
- Updated completeLevelUp to accept and apply selectedSubclass parameter
- Updated all level-up flow handlers (ASI, spells, expertise) to preserve/pass selectedSubclass
- Added SubclassPickerModal render in JSX
- Files changed: src/pages/CharacterSheetPage.tsx
- **Learnings for future iterations:**
  - Level-up flow chains modals: HP -> Subclass (at L3) -> ASI -> Spells -> Expertise -> Summary
  - pendingLevelUp stores all choices that need to be applied at the end
  - When updating pendingLevelUp, use spread operator to preserve existing fields
  - Cancel on required modals (like subclass) should cancel entire level-up

---

## 2026-02-01 - US-006: Auto-add subclass spells when subclass is chosen
- Created getSubclassSpellsForLevel(className, subclassName, level) in calculations.ts
- Created getSubclassSpellsForLevelUp(character, className, subclassName, previousLevel, newLevel)
- Both functions use getSubclass and getSpellByName to look up data
- Added import for getSubclass from classes.ts
- Integrated into completeLevelUp in CharacterSheetPage.tsx
- When selectedSubclass is set (new choice), gets all spells up to current level (previousLevel = 0)
- When leveling up with existing subclass, gets only newly available spells
- Spells added with source: 'Subclass' and notes: 'Always prepared'
- Duplicate check prevents adding spells already in character.spells
- Files changed: src/utils/calculations.ts, src/pages/CharacterSheetPage.tsx
- **Learnings for future iterations:**
  - Pattern: check existing spells before adding with .some() case-insensitive comparison
  - Use spread operator with updated spells array to prevent duplicates from lineage + subclass
  - getSubclass returns undefined if subclass not found, so check for spells field explicitly

---

## 2026-02-01 - US-007: Auto-add subclass spells during level-up
- Already implemented in US-006's completeLevelUp logic
- When character has existing subclass and levels up:
  - subclassForSpells = character.subclass (existing)
  - previousLevelForSubclass = character.level (current level before level-up)
  - newLevel = levelUpResult.character.level (new level after)
- getSubclassSpellsForLevelUp compares levels to find newly available spells
- Works for all classes with subclass spells (Cleric, Warlock, Paladin, Druid, Ranger)
- Files changed: prd.json (marked complete)
- **Learnings for future iterations:**
  - US-006 and US-007 were essentially the same feature, just different scenarios
  - Consider combining stories that are really the same feature in different contexts

---
